<html>
<head>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script src="js/YouTubeToHtml5.min.js"></script>
    <title>Youtube Video in AFrame: Simple Videos</title>
</head>
<body>
    <video data-yt2html5="" style="display:none"></video>
    <input type="text" id="myText" value="Enter Youtube URL" size="40" onclick="reset()"
        style="position: absolute; z-index: 3; left: 50%; bottom: 60px; transform: translate(-50%, -50%); margin: 0 auto;">
    <button type="button" onclick="addUrl()"
        style="position: absolute; z-index: 3; left: 50%; bottom: 20px; transform: translate(-50%, -50%); margin: 0 auto;">Open</button>
    <a-scene renderer="colorManagement: false; physicallyCorrectLights: false; antialias: true;">
        <a-assets>
            <video id="tempVideo" src="" crossorigin="anonymous"></video>
            <a-asset-item id="cinema" src="obj/cinema.gltf"></a-asset-item>
        </a-assets>
        <a-entity gltf-model="#cinema" position="0 0 2">
            <a-plane width="16" height="9" position="0 2 -15" color="gray"></a-plane>
            <a-entity id="playButton" class="clickable" position="-2 -2.8 -14"
                geometry="primitive: plane; height: 1; width: 1.2" text="value: Play; align: center; width: 10; color: orange"
                material="color: black; opacity: 1; alpha-test: 0.5"></a-entity>
            <a-entity id="pauseButton" class="clickable" position="0 -2.8 -14"
                geometry="primitive: plane; height: 1; width: 1.5" text="value: Pause; align: center; width: 10; color: orange"
                material="color: black; opacity: 1; alpha-test: 0.5"></a-entity>
            <a-entity id="stopButton" class="clickable" position="2 -2.8 -14"
                geometry="primitive: plane; height: 1; width: 1.2" text="value: Stop; align: center; width: 10; color: orange"
                material="color: black; opacity: 1; alpha-test: 0.5"></a-entity>
        </a-entity>
        <a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable;"></a-entity>
        <a-entity laser-controls="hand: left" raycaster="objects: .clickable;"></a-entity>
        <!-- <a-entity laser-controls="hand: right" raycaster="objects: .clickable;"></a-entity> -->
        <a-sky color="#000"></a-sky>
    </a-scene>
</body>
<script>
    // Variables
    // Button
    var playVideo = document.querySelector("#playButton");
    var pauseVideo = document.querySelector("#pauseButton");
    var stopVideo = document.querySelector("#stopButton");
    // Video
    var videoSource = document.querySelector("video");
    var tempVideo = document.querySelector("#tempVideo");
    var videoHolder = document.querySelector("a-plane");
    function reset() {
        document.getElementById("myText").value = "";
    }
    function addUrl() {
        var x = document.getElementById("myText").value;
        if (!x || x === "Enter Youtube URL") {
            alert("Please enter a valid YouTube URL");
            return;
        }

        videoSource.setAttribute("data-yt2html5", x);

        const controller = new YouTubeToHtml5({
            withAudio: true, // Filter streams to those with audio channels
            formats: ['720p', '360p', '1080p'] // Try 720p first, then 360p as fallback
        });

        controller.addFilter('request.url', function (url) {
            return `${url}&cache_bust=${(new Date()).getTime()}`;
        });

        // Add a filter to intercept the video source
        controller.addFilter('video.source', function (src) {
            console.log('Video source URL:', src);
            return src;
        });

        // Add action after API call
        controller.addAction('api.after', function(element) {
            console.log('YouTube metadata loaded');
            // Wait a bit for the src to be set, then load it
            setTimeout(() => {
                if (videoSource.src) {
                    console.log('Setting video source to:', videoSource.src);
                    // Use the direct URL from YouTubeToHtml5 (no CORS proxy needed)
                    tempVideo.setAttribute("src", videoSource.src);
                    videoHolder.setAttribute("color", "");
                    videoHolder.setAttribute("src", "#tempVideo");

                    // Wait for video to be loaded before playing
                    tempVideo.addEventListener('loadeddata', function() {
                        console.log('Video loaded successfully');
                        tempVideo.play().catch(err => {
                            console.error('Play error:', err);
                        });
                    }, { once: true });

                    // Add error handler
                    tempVideo.addEventListener('error', function(e) {
                        console.error('Video error:', e);
                        alert('Failed to load video. YouTube may have restrictions on this video.');
                    }, { once: true });

                    tempVideo.load();
                } else {
                    console.error('No video source found');
                    alert('Could not extract video URL. This video may be restricted or private.');
                }
            }, 1000);
        });

        controller.load();
        console.log('YouTube URL submitted:', x);
    }
    playVideo.addEventListener("click", function () {
        if (tempVideo.src) {
            tempVideo.play().catch(err => {
                console.error('Play error:', err);
                alert('Cannot play video. Please load a video first.');
            });
        } else {
            alert('Please load a video first');
        }
    })
    pauseVideo.addEventListener("click", function () {
        if (tempVideo.src) {
            tempVideo.pause();
        } else {
            alert('Please load a video first');
        }
    })
    stopVideo.addEventListener("click", function () {
        if (tempVideo.src) {
            tempVideo.pause();
            tempVideo.currentTime = 0;
        } else {
            alert('Please load a video first');
        }
    })
</script>


</html>
