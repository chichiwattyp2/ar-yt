<html>
<head>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="js/YouTubeToHtml5.min.js"></script>
    <title>Youtube Video in AFrame: Simple Videos</title>
</head>
<body>
    <input type="text" id="myText" value="Enter Youtube URL" size="40" onclick="reset()"
        style="position: absolute; z-index: 3; left: 50%; bottom: 60px; transform: translate(-50%, -50%); margin: 0 auto;">
    <button type="button" onclick="addUrl()"
        style="position: absolute; z-index: 3; left: 50%; bottom: 20px; transform: translate(-50%, -50%); margin: 0 auto;">Open</button>
    <a-scene renderer="colorManagement: false; physicallyCorrectLights: false; antialias: true;">
        <a-assets>
            <video id="tempVideo" src="" crossorigin="anonymous"></video>
            <a-asset-item id="cinema" src="obj/cinema.gltf"></a-asset-item>
        </a-assets>
        <a-entity gltf-model="#cinema" position="0 0 2">
            <a-plane width="16" height="9" position="0 2 -15" color="gray"></a-plane>
            <a-entity id="playButton" class="clickable" position="-2 -2.8 -14"
                geometry="primitive: plane; height: 1; width: 1.2" text="value: Play; align: center; width: 10; color: orange"
                material="color: black; opacity: 1; alpha-test: 0.5"></a-entity>
            <a-entity id="pauseButton" class="clickable" position="0 -2.8 -14"
                geometry="primitive: plane; height: 1; width: 1.5" text="value: Pause; align: center; width: 10; color: orange"
                material="color: black; opacity: 1; alpha-test: 0.5"></a-entity>
            <a-entity id="stopButton" class="clickable" position="2 -2.8 -14"
                geometry="primitive: plane; height: 1; width: 1.2" text="value: Stop; align: center; width: 10; color: orange"
                material="color: black; opacity: 1; alpha-test: 0.5"></a-entity>
        </a-entity>
        <a-entity cursor="rayOrigin: mouse" raycaster="objects: .clickable;"></a-entity>
        <a-entity laser-controls="hand: left" raycaster="objects: .clickable;"></a-entity>
        <!-- <a-entity laser-controls="hand: right" raycaster="objects: .clickable;"></a-entity> -->
        <a-sky color="#000"></a-sky>
    </a-scene>
</body>
<script>
    // Variables
    // Button
    var playVideo = document.querySelector("#playButton");
    var pauseVideo = document.querySelector("#pauseButton");
    var stopVideo = document.querySelector("#stopButton");
    // Video
    var tempVideo = document.querySelector("#tempVideo");
    var videoHolder = document.querySelector("a-plane");
    var currentVideoId = null;

    // Invidious instances to try (public instances)
    const invidiousInstances = [
        'https://invidious.fdn.fr',
        'https://invidious.nerdvpn.de',
        'https://inv.tux.pizza',
        'https://invidious.privacyredirect.com',
        'https://y.com.sb'
    ];

    function reset() {
        document.getElementById("myText").value = "";
    }

    // Extract video ID from YouTube URL
    function extractVideoId(url) {
        const patterns = [
            /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\?\/]+)/,
            /^([a-zA-Z0-9_-]{11})$/
        ];

        for (let pattern of patterns) {
            const match = url.match(pattern);
            if (match && match[1]) {
                return match[1];
            }
        }
        return null;
    }

    // Try to get video URL from Invidious instances
    async function getVideoUrlFromInvidious(videoId, instanceIndex = 0) {
        if (instanceIndex >= invidiousInstances.length) {
            throw new Error('All Invidious instances failed');
        }

        const instance = invidiousInstances[instanceIndex];
        console.log(`Trying Invidious instance: ${instance}`);

        try {
            const response = await fetch(`${instance}/api/v1/videos/${videoId}`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            console.log('Invidious response:', data);

            // Look for adaptive formats with audio
            const formats = data.adaptiveFormats || [];

            // Try to find a good quality video with audio
            const qualities = ['720p', '480p', '360p'];
            for (let quality of qualities) {
                const format = formats.find(f =>
                    f.qualityLabel === quality &&
                    f.type && f.type.includes('video/mp4') &&
                    f.url
                );
                if (format) {
                    console.log(`Found ${quality} format:`, format);
                    return { url: format.url, format: format };
                }
            }

            // Fallback: try formatStreams (combined video+audio)
            if (data.formatStreams && data.formatStreams.length > 0) {
                const format = data.formatStreams.find(f =>
                    f.qualityLabel &&
                    f.type && f.type.includes('video/mp4') &&
                    f.url
                );
                if (format) {
                    console.log('Found combined format:', format);
                    return { url: format.url, format: format };
                }
            }

            throw new Error('No suitable video format found');
        } catch (error) {
            console.error(`Failed with instance ${instance}:`, error);
            // Try next instance
            return getVideoUrlFromInvidious(videoId, instanceIndex + 1);
        }
    }

    async function addUrl() {
        const input = document.getElementById("myText").value;
        if (!input || input === "Enter Youtube URL") {
            alert("Please enter a valid YouTube URL");
            return;
        }

        const videoId = extractVideoId(input);
        if (!videoId) {
            alert("Invalid YouTube URL. Please enter a valid URL like:\nhttps://www.youtube.com/watch?v=VIDEO_ID\nor\nhttps://youtu.be/VIDEO_ID");
            return;
        }

        console.log('Extracted video ID:', videoId);
        currentVideoId = videoId;

        // Show loading message
        const loadingMsg = document.createElement('div');
        loadingMsg.id = 'loading-msg';
        loadingMsg.style.cssText = 'position: absolute; z-index: 4; left: 50%; top: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 10px; font-family: Arial;';
        loadingMsg.textContent = 'Loading video...';
        document.body.appendChild(loadingMsg);

        try {
            const result = await getVideoUrlFromInvidious(videoId);
            console.log('Got video URL:', result.url);

            // Set video source
            tempVideo.src = result.url;
            tempVideo.crossOrigin = 'anonymous';

            // Wait for video to load
            tempVideo.addEventListener('loadeddata', function() {
                console.log('Video loaded successfully');
                videoHolder.setAttribute("color", "");
                videoHolder.setAttribute("src", "#tempVideo");

                // Remove loading message
                const msg = document.getElementById('loading-msg');
                if (msg) msg.remove();

                // Auto-play
                tempVideo.play().catch(err => {
                    console.error('Play error:', err);
                });
            }, { once: true });

            // Add error handler
            tempVideo.addEventListener('error', function(e) {
                console.error('Video error:', e);
                const msg = document.getElementById('loading-msg');
                if (msg) msg.remove();
                alert('Failed to load video. This video may be restricted or unavailable.');
            }, { once: true });

            // Load the video
            tempVideo.load();

        } catch (error) {
            console.error('Failed to load video:', error);
            const msg = document.getElementById('loading-msg');
            if (msg) msg.remove();
            alert('Failed to load video from all sources. The video may be restricted, private, or the Invidious services may be temporarily unavailable.\n\nPlease try:\n1. A different video\n2. Again in a few minutes\n3. Checking if the video is public');
        }
    }
    playVideo.addEventListener("click", function () {
        if (tempVideo.src) {
            tempVideo.play().catch(err => {
                console.error('Play error:', err);
                alert('Cannot play video. Please load a video first.');
            });
        } else {
            alert('Please load a video first');
        }
    })
    pauseVideo.addEventListener("click", function () {
        if (tempVideo.src) {
            tempVideo.pause();
        } else {
            alert('Please load a video first');
        }
    })
    stopVideo.addEventListener("click", function () {
        if (tempVideo.src) {
            tempVideo.pause();
            tempVideo.currentTime = 0;
        } else {
            alert('Please load a video first');
        }
    })
</script>


</html>

